{% extends "base.html" %}

{% block title %}Détails du dossier - {{ dossier.nom_dossier }}{% endblock %}

{% block sidebar %}
    {% include "partials/sidebar.html" %}
{% endblock %}

{% block topbar %}
    {% include "partials/topbar.html" %}
{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4 font-weight-bold text-primary">Dossier : {{ dossier.nom_dossier }}</h2>

  <div class="card shadow-sm rounded p-4 mb-5">
    <div class="row">
      <div class="col-md-6">
        <p><i class="fas fa-hashtag text-secondary mr-2"></i><strong>Numéro interne :</strong> {{ dossier.numero_dossier }}</p>
        <p><i class="fas fa-briefcase text-secondary mr-2"></i><strong>Type :</strong> {{ dossier.type_affaire_param.valeur }}
          {% if dossier.sous_type_affaire_param and dossier.sous_type_affaire_param.valeur %}
            <small class="text-muted fst-italic"> - {{ dossier.sous_type_affaire_param.valeur }}</small>
          {% endif %}
        </p>
        <p><i class="fas fa-bolt text-warning mr-2"></i><strong>Urgence :</strong>
          <span class="badge badge-warning text-dark">{{ dossier.urgence_param.valeur }}</span>
        </p>
        <p><i class="fas fa-user-tag text-secondary mr-2"></i><strong>Rôle du client :</strong> {{ dossier.client.role_client_param.valeur }}</p>
        <p><i class="fas fa-gavel text-secondary mr-2"></i><strong>Juridiction :</strong> {{ dossier.juridiction or '-' }}</p>
      </div>
      <div class="col-md-6">
        <p><i class="fas fa-landmark text-secondary mr-2"></i><strong>Tribunal :</strong> {{ dossier.tribunal or '-' }}</p>
        <p><i class="fas fa-user-tie text-secondary mr-2"></i><strong>Avocat Responsable :</strong> Maître {{ dossier.avocat_nom }}</p>
        <p><i class="fas fa-user-secret text-secondary mr-2"></i><strong>Avocat Adverse :</strong> {{ dossier.avocat_adverse or '-' }}</p>
        <p><i class="fas fa-calendar-alt text-secondary mr-2"></i><strong>Date de création :</strong>
          {{ dossier.date_creation.strftime('%d/%m/%Y %H:%M') if dossier.date_creation else '-' }}
        </p>
      </div>
    </div>

    <!-- Enrôlement -->
    <div class="mt-5 p-4 bg-light rounded shadow-sm">
      <h4 class="mb-3 font-weight-semibold">
        <i class="fas fa-file-signature text-primary mr-2"></i> Enrôlement
      </h4>

      {% if dossier.enrolement %}
        <div class="row">
          <div class="col-md-6">
            <p><strong>Numéro rôle :</strong> {{ dossier.enrolement.numero_role }}</p>
            <p><strong>Date d'enrôlement :</strong> {{ dossier.enrolement.date_enrolement.strftime('%d/%m/%Y') if dossier.enrolement.date_enrolement else '-' }}</p>
            <p><strong>Frais payés :</strong> {{ dossier.enrolement.frais_payes if dossier.enrolement.frais_payes is not none else 'Non renseigné' }} Ariary</p>
          </div>
          <div class="col-md-6">
            <p><strong>Greffier :</strong> {{ dossier.enrolement.greffier or 'Non renseigné' }}</p>
            <p><strong>Preuve d'enrôlement :</strong>
              {% if dossier.enrolement.preuve_enrolement %}
                <a href="{{ url_for('documents', filepath=dossier.enrolement.preuve_enrolement | replace('app/documents/', '')) }}"
                   class="btn btn-outline-primary btn-sm"
                   target="_blank" rel="noopener">
                  <i class="fas fa-file-download mr-1"></i> Télécharger
                </a>
              {% else %}
                <span class="text-muted">Aucune preuve</span>
              {% endif %}
            </p>
          </div>
        </div>
        <a href="/dossiers/{{ dossier.id }}/enrolement" class="btn btn-info btn-sm mt-3">
          <i class="fas fa-pen mr-1"></i> Modifier l'enrôlement
        </a>
      {% else %}
        <p class="text-muted fst-italic">Aucun enrôlement enregistré pour ce dossier.</p>
        <a href="/dossiers/{{ dossier.id }}/enrolement" class="btn btn-success btn-sm mt-3">
          <i class="fas fa-file-signature mr-1"></i> Ajouter un enrôlement
        </a>
      {% endif %}
    </div>

    <!-- Commentaires -->
    <div class="mt-4 p-4 bg-light rounded shadow-sm">
      <h4 class="font-weight-semibold mb-3"><i class="fas fa-comments text-secondary mr-2"></i> Commentaires</h4>
      <p class="fst-italic mb-0">{{ dossier.commentaire or "Aucun commentaire." }}</p>
    </div>

    <!-- Pièces jointes -->
    <div class="mt-4">
      <h4>Pièces jointes</h4>
      {% set relative_path = dossier.dossier_path.replace('app/documents/', '') %}
      {% if dossier.pieces_jointes %}
        <div class="row">
          {% for filename in dossier.pieces_jointes %}
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
              <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column justify-content-between">
                  <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-file-alt fa-2x text-primary mr-3"></i>
                    <h6 class="card-title mb-0 text-truncate" title="{{ filename }}">{{ filename }}</h6>
                  </div>
                  <a href="{{ url_for('documents', filepath=relative_path + '/' + filename) }}"
                     class="btn btn-outline-primary btn-sm mt-auto"
                     download
                     title="Télécharger {{ filename }}">
                    <i class="fas fa-download mr-1"></i> Télécharger
                  </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted fst-italic">Aucune pièce jointe disponible.</p>
      {% endif %}
    </div>

    <div class="mt-5 d-flex gap-3">
      <a href="/dossiers/{{ dossier.id }}/modifier" class="btn btn-warning btn-sm">
        <i class="fas fa-edit mr-2"></i> Modifier
      </a>
      <a href="/dossiers" class="btn btn-secondary btn-sm">
        <i class="fas fa-arrow-left mr-2"></i> Retour à la liste
      </a>
    </div>
  </div>
</div>
{% endblock %}
